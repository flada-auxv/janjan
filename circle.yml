machine:
  ruby:
    version: 2.3.0
  node:
    version: 5.6.0
dependencies:
  cache_directories:
    - vendor/bundle
    - frontend/node_modules
    - frontend/typings
    - /opt/google/chrome/google-chrome
  override:
    - |
        if [[ ! "$(google-chrome --version)" == "Google Chrome 48"* ]]; then
          curl -L -o google-chrome.deb https://dl.google.com/linux/chrome/deb/pool/main/g/google-chrome-stable/google-chrome-stable_48.0.2564.109-1_amd64.deb
          sudo dpkg -i google-chrome.deb
          sudo sed -i 's|HERE/chrome\"|HERE/chrome\" --disable-setuid-sandbox|g' /opt/google/chrome/google-chrome
          rm google-chrome.deb
        fi
    - bundle install -j4 --path=vendor/bundle
    - npm i -g bower
    - bower install
    - cd frontend && npm install && npm run-script build
test:
  override:
    bin/rails t
deployment:
  production:
    branch: master
    commands:
      - |
        if [ -z "${BUNDLE_UPDATE}" ] ; then
          echo 'TODO: deploy'
        else
          gem update bundler --no-document
          gem install circleci-bundle-update-pr
          circleci-bundle-update-pr kashima-bot kashima-bot@users.noreply.github.com
        fi
